/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our Samples at https://docs.gradle.org/9.1.0/samples
 */

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.5'
    id 'io.spring.dependency-management' version "1.1.5"
}

group = 'org.springframework.guides'
version = '0.0.1-SNAPSHOT'

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Project dependencies
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-hateoas'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    runtimeOnly 'com.h2database:h2'
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

springBoot {
    mainClass = 'payroll.PayrollApplication'
}


def targetDirPath = providers.gradleProperty("dirPath") ?: null

tasks.register('cleanDeploymentDir', Delete) {
    //dependsOn 'validateDirectory'
    description = 'Cleans a specific version-controlled directory using -PdirPath'
    group = 'Cleanup'

    def deploymentDirPath = targetDirPath

    if(deploymentDirPath == null) return

    delete fileTree(deploymentDirPath) {
        include '**/*'
    }

    doFirst {
        println "Cleaning contents of: $deploymentDirPath"
    }
}

tasks.register('copyArtifactToDir', Copy) {
    dependsOn 'cleanDeploymentDir'
    dependsOn 'bootJar'

    from layout.buildDirectory.file("libs/${project.name}-${project.version}.jar")

    def deploymentDir = targetDirPath
    into deploymentDir

    doFirst {
        logger.lifecycle("Copying application artifact to: $deploymentDir")
    }
}

tasks.register('copyRuntimeExternalDependencies', Copy) {
    dependsOn 'copyArtifactToDir'

    def subset = providers.gradleProperty("subset") ?: null

    if(subset.present) {
        from configurations.runtimeClasspath.filter { it.name.endsWith(subset.get())}
    } else {
        println "Subset is null, all of the lib files will be copied"
        from configurations.runtimeClasspath
    }

    def libDir = "${targetDirPath.get()}/lib"
    into libDir

    doFirst {
        logger.lifecycle("Copying runtime dependencies to: $libDir")
    }
}
