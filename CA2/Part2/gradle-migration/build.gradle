/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our Samples at https://docs.gradle.org/9.1.0/samples
 */
import org.apache.tools.ant.filters.ReplaceTokens
import java.time.Instant

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.5'
    id 'io.spring.dependency-management' version "1.1.5"
}

group = 'org.springframework.guides'
version = '0.0.1-SNAPSHOT'

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // Project dependencies
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-hateoas'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    runtimeOnly 'com.h2database:h2'
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

springBoot {
    mainClass = 'payroll.PayrollApplication'
}


def targetDirPath = {
    def path = providers.gradleProperty("dirPath")

    if(!path.present) {
        throw new GradleException("The deployment directory path variable is not populated")
    }

    return path.get()
}

tasks.register('cleanDeploymentDir', Delete) {
    description = 'Cleans a specific version-controlled directory using -PdirPath'

    def deploymentDirPath = targetDirPath()

    println "Cleaning contents of: $deploymentDirPath"
    delete deploymentDirPath
}

tasks.register('copyArtifactToDir', Copy) {
    description = 'Generates a jar and copies it to a given directory'
    dependsOn 'bootJar'

    def deploymentDir = targetDirPath()
    delete deploymentDir

    from layout.buildDirectory.file("libs/${project.name}-${project.version}.jar")

    into deploymentDir

    doFirst {
        logger.lifecycle("Copying application artifact to: $deploymentDir")
    }
}

tasks.register('copyRuntimeExternalDependencies', Copy) {
    description = 'Copies a subset of runtime dependencies to /libs in a given directory'

    def libDir = "${targetDirPath()}/lib"
    delete libDir

    def subset = providers.gradleProperty("subset") ?: null

    if(subset.present) {
        from (configurations.runtimeClasspath) {
            include "**/*${subset.get()}"
        }
    } else {
        println "Subset is null, all of the lib files will be copied"
        from configurations.runtimeClasspath
    }

    into libDir

    doFirst {
        logger.lifecycle("Copying runtime dependencies to: $libDir")
    }
}

tasks.register("copyConfigurationFiles", Copy) {
    description = "Copies the configuration files to a given directory and patches them"

    def configDir = "${targetDirPath()}/config"
    delete configDir

    from(sourceSets.main.resources.sourceDirectories)
    {
        include "*.properties"
        filter(ReplaceTokens, tokens: [
                "version":  project.version.toString(),
                "buildTimestamp": Instant.now().toString(),
                "serverPort": providers.gradleProperty("serverPort").getOrElse("8080")
        ])
    }

    into configDir
}

tasks.register("fullDeployment") {
    description = "Full deployment task that cleans a given directory, copies the artifact, runtime dependencies and configuration files"

    dependsOn 'cleanDeploymentDir'
    dependsOn 'copyArtifactToDir'
    dependsOn 'copyRuntimeExternalDependencies'
    dependsOn 'copyConfigurationFiles'
}